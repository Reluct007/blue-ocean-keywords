name: Deploy to Cloudflare Pages

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: read
  deployments: write
  pull-requests: write

jobs:
  # æ„å»ºæµ‹è¯•ä½œä¸š
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œä»£ç æ£€æŸ¥
        run: npm run lint
        continue-on-error: true

      - name: æ„å»ºé¡¹ç›®
        run: npm run build

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            out/
            .next/
          retention-days: 1

  # éƒ¨ç½²åˆ° Cloudflare Pages ä½œä¸š
  deploy-preview:
    name: Deploy Preview (PR)
    needs: build-and-test
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: out

      - name: éƒ¨ç½²åˆ° Cloudflare Pages (Preview)
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: blue-ocean-keywords
          directory: ./out
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.head_ref }}
          # åªåœ¨ PR æ—¶åˆ›å»ºé¢„è§ˆ
          wranglerVersion: '3'

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
  deploy-production:
    name: Deploy Production
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: out

      - name: éƒ¨ç½²åˆ° Cloudflare Pages (Production)
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: blue-ocean-keywords
          directory: ./out
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          production: true
          wranglerVersion: '3'

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš€ éƒ¨ç½²æˆåŠŸ: ${new Date().toLocaleString()}`,
              body: `
                ## éƒ¨ç½²çŠ¶æ€: âœ… æˆåŠŸ

                **æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
                **åˆ†æ”¯**: ${context.ref}
                **æäº¤**: ${context.sha.substring(0, 7)}

                ğŸŒŠ è“æµ·å…³é”®è¯åˆ†æå·¥å…·å·²æˆåŠŸéƒ¨ç½²åˆ° Cloudflare Pagesï¼

                è®¿é—®åœ°å€: https://blue-ocean-keywords.pages.dev
              `,
              labels: ['deployment', 'automation']
            });